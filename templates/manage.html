{% extends "layout.html" %}

{% block title %}Manage Data - Penderita DM Jawa Barat{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-8" data-aos="fade-down">
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Manage Data</h1>
    <p class="text-gray-500 dark:text-gray-400">Create, Read, Update, Delete data penderita DM</p>
</div>

<!-- Messages -->
<div class="p-4 mb-6 bg-green-50 border border-green-200 rounded-lg dark:bg-green-900 dark:border-green-800 hidden" id="successMsg">
    <p class="text-sm text-green-800 dark:text-green-300"></p>
</div>
<div class="p-4 mb-6 bg-red-50 border border-red-200 rounded-lg dark:bg-red-900 dark:border-red-800 hidden" id="errorMsg">
    <p class="text-sm text-red-800 dark:text-red-300"></p>
</div>

<!-- Statistics -->
<div class="grid gap-6 mb-8 md:grid-cols-3" data-aos="fade-up">
    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 shadow-sm">
        <div class="flex items-start justify-between">
            <div class="flex-1">
                <p class="text-sm text-gray-500 dark:text-gray-400 uppercase tracking-wider">Total Records</p>
                <p class="text-4xl font-bold text-gray-900 dark:text-white mb-2">{{ total_records }}</p>
            </div>
            <div class="flex items-center justify-center w-12 h-12 rounded-full bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300 ml-2">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2zM3 16a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2z"></path></svg>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 shadow-sm">
        <div class="flex items-start justify-between">
            <div class="flex-1">
                <p class="text-sm text-gray-500 dark:text-gray-400 uppercase tracking-wider">Kabupaten/Kota</p>
                <p class="text-4xl font-bold text-gray-900 dark:text-white mb-2">{{ kota_list|length }}</p>
            </div>
            <div class="flex items-center justify-center w-12 h-12 rounded-full bg-green-100 text-green-600 dark:bg-green-900 dark:text-green-300 ml-2">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L9.9 13.95a.75.75 0 01-1.06-1.06l4.05-4.05a7 7 0 00-9.9-9.9zM9.5 9.5a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" clip-rule="evenodd"></path></svg>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 shadow-sm">
        <div class="flex items-start justify-between">
            <div class="flex-1">
                <p class="text-sm text-gray-500 dark:text-gray-400 uppercase tracking-wider">Tahun Data</p>
                <p class="text-4xl font-bold text-gray-900 dark:text-white mb-2">{{ tahun_list|length }}</p>
            </div>
            <div class="flex items-center justify-center w-12 h-12 rounded-full bg-purple-100 text-purple-600 dark:bg-purple-900 dark:text-purple-300 ml-2">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M5.5 13a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.3A4.5 4.5 0 1113.5 13H11V9.413l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13H5.5z"></path></svg>
            </div>
        </div>
    </div>
</div>

<!-- Add Data Form -->
<div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 shadow-md mb-6" data-aos="fade-up" data-aos-delay="200">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">‚ûï Tambah Data Baru</h3>
    <form id="addForm" class="grid gap-4 md:grid-cols-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-400 mb-2">Tahun</label>
            <input type="number" name="tahun" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-900 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" min="2010" max="2099" required>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-400 mb-2">Kabupaten/Kota</label>
            <select name="kota" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-900 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" required>
                <option value="">-- Pilih --</option>
                {% for kota in kota_list %}
                <option value="{{ kota }}">{{ kota }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-400 mb-2">Jumlah Penderita</label>
            <input type="number" name="jumlah" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-900 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" min="0" required>
        </div>

        <div class="flex items-end">
            <button type="submit" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium">‚úÖ Tambah</button>
        </div>
    </form>
</div>

<!-- Data Table -->
<div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 shadow-md" data-aos="fade-up" data-aos-delay="400">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">üìä Data Tersimpan</h3>
    <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                <tr>
                    <th scope="col" class="px-6 py-3">No</th>
                    <th scope="col" class="px-6 py-3">Tahun</th>
                    <th scope="col" class="px-6 py-3">Kabupaten/Kota</th>
                    <th scope="col" class="px-6 py-3">Jumlah Penderita</th>
                    <th scope="col" class="px-6 py-3">Kategori</th>
                    <th scope="col" class="px-6 py-3">Aksi</th>
                </tr>
            </thead>
            <tbody id="dataTable">
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                    <td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Info -->
<div class="p-4 mt-6 bg-blue-50 border border-blue-200 rounded-lg dark:bg-blue-900 dark:border-blue-800" data-aos="fade-up" data-aos-delay="600">
    <p class="text-sm text-blue-800 dark:text-blue-300">
        <strong>üí° Tips:</strong> Gunakan form di atas untuk menambah data baru. Gunakan tombol Edit/Delete untuk mengubah atau menghapus data yang sudah ada.
    </p>
</div>

<!-- Edit Modal -->
<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg max-w-sm w-full">
        <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">‚úèÔ∏è Edit Data</h3>
            <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl">&times;</button>
        </div>
        <form id="editForm" class="p-6 space-y-4">
            <input type="hidden" name="row_id" id="editRowId">

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-400 mb-2">Tahun</label>
                <input type="number" name="tahun" id="editTahun" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-900 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" min="2010" max="2099" required>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-400 mb-2">Kabupaten/Kota</label>
                <select name="kota" id="editKota" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-900 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                    <option value="">-- Pilih --</option>
                    {% for kota in kota_list %}
                    <option value="{{ kota }}">{{ kota }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-400 mb-2">Jumlah Penderita</label>
                <input type="number" name="jumlah" id="editJumlah" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-900 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" min="0" required>
            </div>

            <div class="flex gap-2 pt-4">
                <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium">üíæ Simpan</button>
                <button type="button" onclick="closeEditModal()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-900 rounded-lg hover:bg-gray-300 text-sm font-medium dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600">Batal</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Load data on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadData();
    });

    // Add data form submission
    document.getElementById('addForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('/api/add', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showSuccess('Data berhasil ditambahkan!');
                document.getElementById('addForm').reset();
                loadData();
            } else {
                showError(data.message || 'Gagal menambahkan data');
            }
        })
        .catch(error => showError('Error: ' + error.message));
    });

    // Edit form submission
    document.getElementById('editForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const rowId = document.getElementById('editRowId').value;
        const formData = new FormData(this);
        
        fetch(`/api/edit/${rowId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showSuccess('Data berhasil diperbarui!');
                closeEditModal();
                loadData();
            } else {
                showError(data.message || 'Gagal memperbarui data');
            }
        })
        .catch(error => showError('Error: ' + error.message));
    });

    function loadData() {
        fetch('/api/data')
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('dataTable');
                tbody.innerHTML = '';
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">Tidak ada data</td></tr>';
                    return;
                }
                
                data.forEach((row, index) => {
                    const tr = document.createElement('tr');
                    let kategoriBadge;
                    if (row.kategori_dm === 'Tinggi') {
                        kategoriBadge = `<span class="px-3 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">${row.kategori_dm}</span>`;
                    } else if (row.kategori_dm === 'Sedang') {
                        kategoriBadge = `<span class="px-3 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">${row.kategori_dm}</span>`;
                    } else {
                        kategoriBadge = `<span class="px-3 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">${row.kategori_dm}</span>`;
                    }
                    
                    tr.classList.add('bg-white', 'border-b', 'dark:bg-gray-800', 'dark:border-gray-700', 'hover:bg-gray-50', 'dark:hover:bg-gray-700');
                    tr.innerHTML = `
                        <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">${index + 1}</td>
                        <td class="px-6 py-4">${row.tahun}</td>
                        <td class="px-6 py-4">${row.nama_kabupaten_kota}</td>
                        <td class="px-6 py-4">${row.jumlah_penderita_dm.toLocaleString('id-ID')}</td>
                        <td class="px-6 py-4">${kategoriBadge}</td>
                        <td class="px-6 py-4 space-x-2">
                            <button onclick="openEditModal(${index}, ${row.tahun}, '${row.nama_kabupaten_kota}', ${row.jumlah_penderita_dm})" class="text-blue-600 hover:text-blue-800 dark:text-blue-500 dark:hover:text-blue-700 font-medium">Edit</button>
                            <button onclick="deleteData(${index})" class="text-red-600 hover:text-red-800 dark:text-red-500 dark:hover:text-red-700 font-medium">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            })
            .catch(error => {
                document.getElementById('dataTable').innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Gagal memuat data</td></tr>';
                console.error('Error:', error);
            });
    }

    function openEditModal(rowId, tahun, kota, jumlah) {
        document.getElementById('editRowId').value = rowId;
        document.getElementById('editTahun').value = tahun;
        document.getElementById('editKota').value = kota;
        document.getElementById('editJumlah').value = jumlah;
        document.getElementById('editModal').classList.remove('hidden');
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
    }

    function deleteData(rowId) {
        if (!confirm('Yakin ingin menghapus data ini?')) return;
        
        fetch(`/api/delete/${rowId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showSuccess('Data berhasil dihapus!');
                loadData();
            } else {
                showError(data.message || 'Gagal menghapus data');
            }
        })
        .catch(error => showError('Error: ' + error.message));
    }

    function showSuccess(message) {
        const msg = document.getElementById('successMsg');
        msg.querySelector('p').textContent = '‚úÖ ' + message;
        msg.classList.remove('hidden');
        setTimeout(() => {
            msg.classList.add('hidden');
        }, 5000);
    }

    function showError(message) {
        const msg = document.getElementById('errorMsg');
        msg.querySelector('p').textContent = '‚ùå ' + message;
        msg.classList.remove('hidden');
        setTimeout(() => {
            msg.classList.add('hidden');
        }, 5000);
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('editModal');
        if (event.target === modal) {
            modal.classList.add('hidden');
        }
    }
</script>
{% endblock %}
